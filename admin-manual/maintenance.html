<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Maintenance &#8212; ecs-admin-manual 2019-02-21@14:22 documentation</title>
    
    <link rel="stylesheet" href="_static/better.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2019-02-21@14:22',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="top" title="ecs-admin-manual 2019-02-21@14:22 documentation" href="index.html" />
    <link rel="next" title="Digital signed pdf documents" href="mocca_pdfas.html" />
    <link rel="prev" title="Configure Appliance" href="configuration.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="static/custom.css" type="text/css" />
  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="maintenance">
<span id="maintenance"></span><h1>Maintenance<a class="headerlink" href="#maintenance" title="Permalink to this headline">¶</a></h1>
<div class="section" id="reconfigure-a-running-appliance">
<span id="reconfigure-a-running-appliance"></span><h2>Reconfigure a running Appliance<a class="headerlink" href="#reconfigure-a-running-appliance" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>edit /app/env.yml</li>
<li>optional, build new env package:<ul>
<li>first time requisites install, call <code class="docutils literal"><span class="pre">env-package.sh</span> <span class="pre">--requirements</span></code></li>
<li>build new env package call <code class="docutils literal"><span class="pre">env-package.sh</span> <span class="pre">/app/env.yml</span></code></li>
</ul>
</li>
<li>activate changes into current environment, call <code class="docutils literal"><span class="pre">env-update.sh</span></code></li>
<li>restart and apply new environment: <code class="docutils literal"><span class="pre">systemctl</span> <span class="pre">restart</span> <span class="pre">appliance</span></code></li>
</ul>
</div>
<div class="section" id="start-stop-update-appliance">
<span id="start-stop-update-appliance"></span><h2>Start, Stop, Update Appliance<a class="headerlink" href="#start-stop-update-appliance" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Start appliance: <code class="docutils literal"><span class="pre">systemctl</span> <span class="pre">start</span> <span class="pre">appliance</span></code></li>
<li>Stop appliance: <code class="docutils literal"><span class="pre">systemctl</span> <span class="pre">stop</span> <span class="pre">appliance</span></code></li>
<li>Update Appliance (appliance and ecs): <code class="docutils literal"><span class="pre">systemctl</span> <span class="pre">start</span> <span class="pre">appliance-update</span></code></li>
</ul>
</div>
<div class="section" id="recover-from-failed-state">
<span id="recover-from-failed-state"></span><h2>Recover from failed state<a class="headerlink" href="#recover-from-failed-state" title="Permalink to this headline">¶</a></h2>
<p>if the appliance.service enters fail state, it creates a file named
&#8220;/run/appliance_failed&#8221;.</p>
<p>After resolving the issue, remove this file using <code class="docutils literal"><span class="pre">rm</span> <span class="pre">/run/appliance_failed</span></code>
before restarting the service using <code class="docutils literal"><span class="pre">systemctl</span> <span class="pre">restart</span> <span class="pre">appliance</span></code>.</p>
<p>If the issue was within the ecs-appliance sourcecode, re-run an appliance update:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">rm</span> <span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">appliance</span><span class="o">-</span><span class="n">failed</span>
<span class="n">touch</span> <span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">flags</span><span class="o">/</span><span class="n">force</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">appliance</span>
<span class="n">systemctl</span> <span class="n">restart</span> <span class="n">appliance</span><span class="o">-</span><span class="n">update</span>
</pre></div>
</div>
</div>
<div class="section" id="desaster-recovery-from-backup">
<span id="desaster-recovery-from-backup"></span><h2>Desaster Recovery from backup<a class="headerlink" href="#desaster-recovery-from-backup" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>install a new unconfigured appliance as described in chapter install</li>
<li>copy old saved env.yml to new target machine at /app/env.yml</li>
<li>reboot new target machine, appliance will configure but stop because of empty database</li>
<li>ssh into new target machine, execute <code class="docutils literal"><span class="pre">recover-from-backup.sh</span> <span class="pre">--yes-i-am-sure</span></code></li>
</ul>
</div>
<div class="section" id="automatic-updates">
<span id="automatic-updates"></span><h2>Automatic Updates<a class="headerlink" href="#automatic-updates" title="Permalink to this headline">¶</a></h2>
<p>Updates are scheduled depending appliance:update:oncalendar once per day at 06:30 per default.</p>
<p>Depending the types of updates available the update will take between 1 and 5 minutes in most cases, 5-10 minutes if the ecs container will be rebuild and up to 30 minutes if there are database migrations to be executed.</p>
<p>The following items are updated:</p>
<ul class="simple">
<li>appliance source will be updated and executed</li>
<li>all system packages are updated, special precautions are taken for docker, postgresql and the kernel including a reboot if needed</li>
<li>lets encrypt certificates are updated</li>
<li>ecs source will be updated and rebuild<ul>
<li>the ecs-docs source will be updated</li>
<li>the corresponding support container will be updated</li>
<li>database migrations will be executed (including a dump before doing so)</li>
</ul>
</li>
</ul>
<p><strong>Warning</strong>: Automatic updates are intended to run with Metric and Alert support, so you will get alerts to react and can investigate using the Metric Server to find the root cause. <strong>If you do not make metric recording and alerting, we recommend updating only manual.</strong> To do this, enter &#8220;False&#8221; under appliance:update:automatic in the file env.yml. For a manual update run call <code class="docutils literal"><span class="pre">systemctl</span> <span class="pre">start</span> <span class="pre">appliance-update</span></code></p>
</div>
<div class="section" id="backup-configuration">
<span id="backup-configuration"></span><h2>Backup Configuration<a class="headerlink" href="#backup-configuration" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Backup is done using duplicity, see <a class="reference external" href="http://duplicity.nongnu.org/duplicity.1.html">Duplicity Manual</a></li>
<li>Cycle: Backup is done once per day around 00:30</li>
<li>Safety Measures for backup:<ul>
<li>Database must exist</li>
<li>Storage-Vault must not be empty</li>
</ul>
</li>
<li>Contents:<ul>
<li>/data/ecs-storage-vault: All uploaded and all created documents</li>
<li>/data/ecs-pgdump: Current database dump</li>
</ul>
</li>
<li>Type, Rotation &amp; Retention:<ul>
<li>Backup will start with a full backup and do incremental backups afterwards</li>
<li>2 Months after the first full backup a second full backup will be created</li>
<li>Rotation: Every Backup (full or incremental) will be purged after 4 Months</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="logging-configuration">
<span id="logging-configuration"></span><h2>Logging Configuration<a class="headerlink" href="#logging-configuration" title="Permalink to this headline">¶</a></h2>
<p>Container:</p>
<ul class="simple">
<li>all container log to stdout and stderr</li>
<li>docker has the logs of every container available<ul>
<li>look at a log stream using eg. <code class="docutils literal"><span class="pre">docker</span> <span class="pre">logs</span> <span class="pre">ecs_ecs.web_1</span></code></li>
</ul>
</li>
<li>journald will get the container logs via the appliance.service which calls docker-compose<ul>
<li>this includes backend nginx, uwsgi, beat, worker, smtpd, redis, memcached, pdfas, mocca</li>
<li>to follow use <code class="docutils literal"><span class="pre">journalctl</span> <span class="pre">-u</span> <span class="pre">appliance</span> <span class="pre">-f</span></code></li>
</ul>
</li>
</ul>
<p>Host:</p>
<ul class="simple">
<li>all logging (except postgres) is going through journald</li>
<li>follow whole journal: <code class="docutils literal"><span class="pre">journalctl</span> <span class="pre">-f</span></code></li>
<li>only follow service, eg. prepare-appliance: <code class="docutils literal"><span class="pre">journalctl</span> <span class="pre">-u</span> <span class="pre">prepare-appliance</span> <span class="pre">-f</span></code></li>
<li>follow frontend nginx: <code class="docutils literal"><span class="pre">journalctl</span> <span class="pre">-u</span> <span class="pre">nginx</span> <span class="pre">-f</span></code></li>
<li>search for salt-call output: <code class="docutils literal"><span class="pre">journalctl</span> <span class="pre">$(which</span> <span class="pre">salt-call)</span></code></li>
</ul>
</div>
<div class="section" id="metrics-collection">
<span id="metrics-collection"></span><h2>Metrics Collection<a class="headerlink" href="#metrics-collection" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>if <code class="docutils literal"><span class="pre">appliance:metric:exporter</span></code> is set, metrics are exported from the subsystems<ul>
<li>export metrics of:
frontend nginx, redis, memcached, uwsgi, cadvisor,
process details(uwsgi, postgres, nginx, celery),
prometheus node(diskstats, entropy, filefd, filesystem, hwmon, loadavg,
mdadm, meminfo, netdev, netstat, stat, textfile, time, uname, vmstat)</li>
<li>additional service metrics from: appliance-backup, appliance-update</li>
</ul>
</li>
<li>if <code class="docutils literal"><span class="pre">appliance:metric:server</span></code> is set, these exported metrics are collected and
stored by a prometheus server and alerts are issued using email to root
using the prometheus alert server<ul>
<li>there are alerts for: NodeRebootsTooOften, NodeFilesystemFree, NodeMemoryUsageHigh, NodeLoadHigh, a.o.<ul>
<li>for a detailed alert list look at the <a class="reference external" href="https://github.com/ecs-org/ecs-appliance/blob/master/salt/appliance/metric/alert.rules.yml">alert.rules.yml sourcefile</a></li>
<li>to <strong>add custom rules create rules</strong> files in the config yaml using &#8220;file:<em>:contents&#8221; with a path of &#8220;/app/etc/prometheus-rules.d/</em>.rules.yml&#8221;</li>
</ul>
</li>
<li>the prometheus gui is at <a class="reference external" href="http://172.17.0.1:9090">http://172.17.0.1:9090</a></li>
<li>the prometheus alert gui is at <a class="reference external" href="http://172.17.0.1:9093">http://172.17.0.1:9093</a></li>
</ul>
</li>
<li>if <code class="docutils literal"><span class="pre">appliance:metric:gui</span></code> is set, a grafana server is started to display the collected metrics<ul>
<li>grafana is available at <a class="reference external" href="http://localhost:3000">http://localhost:3000</a></li>
</ul>
</li>
<li>if <code class="docutils literal"><span class="pre">appliance:metric:pghero</span></code> is set, start a pghero instance for postgres inspection<ul>
<li>pghero is avaiable at <a class="reference external" href="http://localhost:5081">http://localhost:5081</a></li>
</ul>
</li>
</ul>
<p>Use ssh port forwarding to access these ports, eg. for 172.17.0.1:9090 use <code class="docutils literal"><span class="pre">ssh</span> <span class="pre">root&#64;hostname</span> <span class="pre">-L</span> <span class="pre">9090:172.17.0.1:9090</span></code></p>
</div>
<div class="section" id="alerting-setup">
<span id="alerting-setup"></span><h2>Alerting Setup<a class="headerlink" href="#alerting-setup" title="Permalink to this headline">¶</a></h2>
<p>if <code class="docutils literal"><span class="pre">ecs:settings[&quot;SENTRY_DSN&quot;]</span></code> and <code class="docutils literal"><span class="pre">appliance:sentry:dsn</span></code> are defined,
the appliance will report the following items to sentry:</p>
<ul class="simple">
<li>python exceptions in web, worker, beat, smtpd</li>
<li>salt-call exceptions and state returns with error states</li>
<li>systemd service exceptions where appliance-failed or service-failed is triggered</li>
<li>shell calls to appliance.include: appliance_failed, appliance_exit, sentry_entry</li>
<li>internal mails to root, eg. prometheus alerts</li>
</ul>
</div>
<div class="section" id="email-challenges">
<span id="email-challenges"></span><h2>Email Challenges<a class="headerlink" href="#email-challenges" title="Permalink to this headline">¶</a></h2>
<div class="section" id="mail-send-from-ecs-to-emailserver-doing-greylisting">
<span id="mail-send-from-ecs-to-emailserver-doing-greylisting"></span><h3>Mail send from ECS to Emailserver doing greylisting<a class="headerlink" href="#mail-send-from-ecs-to-emailserver-doing-greylisting" title="Permalink to this headline">¶</a></h3>
<p>Issue:
Emails send from the appliance to a target mailserver that does greylisting will always be delayed.</p>
<p>Resolution:
To remove those delays, the greylisting whitelist of the target mailserver has to be extended with the domain of the ecs appliance.</p>
<p>Technical Background:
The appliance always uses a new unique email address for each outgoing mail (beside registration) and greylisting always delays the first email from an email address.</p>
</div>
</div>
<div class="section" id="maintenance-commands-in-a-running-ecs-container">
<span id="maintenance-commands-in-a-running-ecs-container"></span><h2>Maintenance commands in a running ecs container<a class="headerlink" href="#maintenance-commands-in-a-running-ecs-container" title="Permalink to this headline">¶</a></h2>
<p>for most ecs commands it is not important to which instance (web,worker)
you connect to, &#8220;ecs_ecs.web_1&#8221; is used as example.</p>
<ul class="simple">
<li>image = ecs, mocca, pdfas, memcached, redis</li>
<li>ecs.startcommand = web, worker, beat, smtpd</li>
<li>as root <code class="docutils literal"><span class="pre">docker</span> <span class="pre">exec</span> <span class="pre">-it</span> <span class="pre">ecs_image[.startcommand]_1</span> <span class="pre">/path/to/command</span></code><ul>
<li>eg. <code class="docutils literal"><span class="pre">docker</span> <span class="pre">exec</span> <span class="pre">-it</span> <span class="pre">ecs_ecs.web_1</span> <span class="pre">/bin/bash</span></code></li>
</ul>
</li>
<li>shell as app user with activated environment<ul>
<li><code class="docutils literal"><span class="pre">docker</span> <span class="pre">exec</span> <span class="pre">-it</span> <span class="pre">ecs_ecs.web_1</span> <span class="pre">/start</span> <span class="pre">run</span> <span class="pre">/bin/bash</span></code></li>
</ul>
</li>
<li>manualy create a celery task:<ul>
<li><code class="docutils literal"><span class="pre">docker</span> <span class="pre">exec</span> <span class="pre">-it</span> <span class="pre">ecs_ecs.web_1</span> <span class="pre">/start</span> <span class="pre">run</span> <span class="pre">celery</span> <span class="pre">--serializer=pickle</span> <span class="pre">-A</span> <span class="pre">ecs</span> <span class="pre">call</span> <span class="pre">ecs.integration.tasks.clearsessions</span></code></li>
</ul>
</li>
<li>celery events console<ul>
<li><code class="docutils literal"><span class="pre">docker</span> <span class="pre">exec</span> <span class="pre">-it</span> <span class="pre">ecs_ecs.web_1</span> <span class="pre">/start</span> <span class="pre">run</span> <span class="pre">/bin/bash</span> <span class="pre">-c</span> <span class="pre">&quot;TERM=screen</span> <span class="pre">celery</span> <span class="pre">-A</span> <span class="pre">ecs</span> <span class="pre">events&quot;</span></code></li>
</ul>
</li>
<li>enter a django shell_plus as app user in a running container<ul>
<li><code class="docutils literal"><span class="pre">docker</span> <span class="pre">exec</span> <span class="pre">-it</span> <span class="pre">ecs_ecs.web_1</span> <span class="pre">/start</span> <span class="pre">run</span> <span class="pre">./manage.py</span> <span class="pre">shell_plus</span></code></li>
</ul>
</li>
<li>generate all workflow graphs</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">ecs_ecs</span><span class="o">.</span><span class="n">web_1</span> <span class="o">/</span><span class="n">start</span> <span class="n">run</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="o">./</span><span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">workflow_dot</span> <span class="n">core</span><span class="o">.</span><span class="n">submission</span> <span class="o">|</span> <span class="n">dot</span> <span class="o">-</span><span class="n">Tpng</span> <span class="o">-</span><span class="n">osubmission</span><span class="o">.</span><span class="n">png</span>
<span class="o">./</span><span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">workflow_dot</span> <span class="n">notifications</span><span class="o">.</span><span class="n">notification</span> <span class="o">|</span> <span class="n">dot</span> <span class="o">-</span><span class="n">Tpng</span> <span class="o">-</span><span class="n">onotification</span><span class="o">.</span><span class="n">png</span>
<span class="o">./</span><span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">workflow_dot</span> <span class="n">votes</span><span class="o">.</span><span class="n">vote</span> <span class="o">|</span> <span class="n">dot</span> <span class="o">-</span><span class="n">Tpng</span> <span class="o">-</span><span class="n">ovote</span><span class="o">.</span><span class="n">png</span>
</pre></div>
</div>
<ul class="simple">
<li>generate ECX-Format Documentation</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">ecs_ecs</span><span class="o">.</span><span class="n">web_1</span> <span class="o">/</span><span class="n">start</span> <span class="n">run</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="o">./</span><span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">ecx_format</span> <span class="o">-</span><span class="n">t</span> <span class="n">html</span> <span class="o">-</span><span class="n">o</span> <span class="n">ecx</span><span class="o">-</span><span class="nb">format</span><span class="o">.</span><span class="n">html</span>
<span class="o">./</span><span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">ecx_format</span> <span class="o">-</span><span class="n">t</span> <span class="n">pdf</span> <span class="o">-</span><span class="n">o</span> <span class="n">ecx</span><span class="o">-</span><span class="nb">format</span><span class="o">.</span><span class="n">pdf</span>
</pre></div>
</div>
</div>
<div class="section" id="maintenance-commands-for-the-appliance-host">
<span id="maintenance-commands-for-the-appliance-host"></span><h2>Maintenance commands for the appliance host<a class="headerlink" href="#maintenance-commands-for-the-appliance-host" title="Permalink to this headline">¶</a></h2>
<p>All snippets expect root.</p>
<ul class="simple">
<li>destroy and recreate database:</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">gosu</span> <span class="n">app</span> <span class="n">dropdb</span> <span class="n">ecs</span>
<span class="n">gosu</span> <span class="n">postgres</span> <span class="n">createdb</span> <span class="n">ecs</span> <span class="o">-</span><span class="n">T</span> <span class="n">template0</span> <span class="o">-</span><span class="n">l</span> <span class="n">de_DE</span><span class="o">.</span><span class="n">utf8</span>
<span class="n">rm</span> <span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">tags</span><span class="o">/</span><span class="n">last_running_ecs</span>
<span class="n">systemctl</span> <span class="n">restart</span> <span class="n">appliance</span>
</pre></div>
</div>
<ul class="simple">
<li>get latest dump from backup to /root/ecs.pgdump.gz:<ul>
<li><code class="docutils literal"><span class="pre">duply</span> <span class="pre">/root/.duply/appliance-backup</span> <span class="pre">fetch</span> <span class="pre">ecs-pgdump/ecs.pgdump.gz</span> <span class="pre">/root/ecs.pgdump.gz</span></code></li>
</ul>
</li>
<li>quick update appliance code:<ul>
<li><code class="docutils literal"><span class="pre">cd</span> <span class="pre">/app/appliance;</span> <span class="pre">gosu</span> <span class="pre">app</span> <span class="pre">git</span> <span class="pre">pull;</span> <span class="pre">salt-call</span> <span class="pre">state.highstate</span> <span class="pre">pillar='{&quot;appliance&quot;:{&quot;enabled&quot;:true}}'</span> <span class="pre">2&gt;&amp;1;</span> <span class="pre">rm</span> <span class="pre">/var/www/html/503.html</span></code></li>
</ul>
</li>
<li>check which system packages are available for update:<ul>
<li><code class="docutils literal"><span class="pre">/usr/lib/update-notifier/apt-check</span> <span class="pre">-p</span></code></li>
</ul>
</li>
<li>cleanup last activity stamps for unattended upgrades, so unattended-upgrades will do all activity again<ul>
<li><code class="docutils literal"><span class="pre">touch</span> <span class="pre">/app/etc/flags/force.update.system</span></code> before <code class="docutils literal"><span class="pre">systemctl</span> <span class="pre">start</span> <span class="pre">appliance-update</span></code></li>
</ul>
</li>
<li>list active systemd timer: <code class="docutils literal"><span class="pre">systemctl</span> <span class="pre">list-timers</span> <span class="pre">--all</span></code></li>
<li>display systemd service change: <code class="docutils literal"><span class="pre">journalctl</span> <span class="pre">-m</span> <span class="pre">_PID=1</span> <span class="pre">-f</span></code></li>
<li>manual run letsencrypt client (do not call as root): <code class="docutils literal"><span class="pre">gosu</span> <span class="pre">app</span> <span class="pre">dehydrated</span> <span class="pre">--help</span></code></li>
<li>display revoked certificates serials:<ul>
<li><code class="docutils literal"><span class="pre">openssl</span> <span class="pre">crl</span> <span class="pre">-inform</span> <span class="pre">PEM</span> <span class="pre">-text</span> <span class="pre">-noout</span> <span class="pre">-in</span> <span class="pre">/app/etc/crl.pem</span></code></li>
</ul>
</li>
<li>get cummulative cpu,mem,net,disk statistics of container:<ul>
<li><code class="docutils literal"><span class="pre">docker</span> <span class="pre">stats</span> <span class="pre">$(docker</span> <span class="pre">ps|grep</span> <span class="pre">-v</span> <span class="pre">&quot;NAMES&quot;|awk</span> <span class="pre">'{</span> <span class="pre">print</span> <span class="pre">$NF</span> <span class="pre">}'|tr</span> <span class="pre">&quot;\n&quot;</span> <span class="pre">&quot;</span> <span class="pre">&quot;)</span></code></li>
</ul>
</li>
<li>read details of a container in yaml:<ul>
<li><code class="docutils literal"><span class="pre">docker</span> <span class="pre">inspect</span> <span class="pre">1b17069fe3ba</span> <span class="pre">|</span> <span class="pre">python</span> <span class="pre">-c</span> <span class="pre">'import</span> <span class="pre">sys,</span> <span class="pre">yaml,</span> <span class="pre">json;</span> <span class="pre">yaml.safe_dump(json.load(sys.stdin),</span> <span class="pre">sys.stdout,</span> <span class="pre">default_flow_style=False)'</span> <span class="pre">|</span> <span class="pre">less</span></code></li>
</ul>
</li>
<li>activate /run/active-env.yml in current shell of appliance vm:<ul>
<li><code class="docutils literal"><span class="pre">.</span> <span class="pre">/usr/local/share/appliance/env.include;</span> <span class="pre">ENV_YML=/run/active-env.yml</span> <span class="pre">userdata_to_env</span> <span class="pre">ecs,appliance</span></code></li>
<li>to also set *GIT_SOURCE defaults: <code class="docutils literal"><span class="pre">.</span> <span class="pre">/usr/local/share/appliance/appliance.include</span></code></li>
</ul>
</li>
<li>send sentry test entry:</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">.</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">appliance</span><span class="o">/</span><span class="n">env</span><span class="o">.</span><span class="n">include</span><span class="p">;</span> <span class="o">.</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">appliance</span><span class="o">/</span><span class="n">appliance</span><span class="o">.</span><span class="n">include</span><span class="p">;</span> <span class="n">ENV_YML</span><span class="o">=/</span><span class="n">run</span><span class="o">/</span><span class="n">active</span><span class="o">-</span><span class="n">env</span><span class="o">.</span><span class="n">yml</span> <span class="n">userdata_to_env</span> <span class="n">ecs</span><span class="p">,</span><span class="n">appliance</span><span class="p">;</span> <span class="n">sentry_entry</span> <span class="s2">&quot;test&quot;</span> <span class="s2">&quot;Test Message $(hostname -f)&quot;</span>
</pre></div>
</div>
<ul class="simple">
<li>most time spent in state.highstate:<ul>
<li><code class="docutils literal"><span class="pre">journalctl</span> <span class="pre">-u</span> <span class="pre">appliance-update</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">-B</span> <span class="pre">5</span> <span class="pre">-E</span> <span class="pre">&quot;Duration:</span> <span class="pre">[0-9]{3,5}\.&quot;</span></code></li>
<li><code class="docutils literal"><span class="pre">journalctl</span> <span class="pre">-u</span> <span class="pre">appliance-update</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">&quot;ID:&quot;</span> <span class="pre">-A6</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">-E</span> <span class="pre">&quot;(ID:|Function:|Duration:)&quot;</span> <span class="pre">|</span> <span class="pre">sed</span> <span class="pre">-r</span> <span class="pre">&quot;s/.*(ID:|Function:|Duration)(.*)/\1</span> <span class="pre">\2/g&quot;</span> <span class="pre">|</span> <span class="pre">paste</span> <span class="pre">-s</span> <span class="pre">-d</span> <span class="pre">'</span> <span class="pre">\n'</span> <span class="pre">-</span> <span class="pre">|</span> <span class="pre">sed</span> <span class="pre">-r</span> <span class="pre">&quot;s/ID:</span> <span class="pre">+([^</span> <span class="pre">]+)</span> <span class="pre">Function:</span> <span class="pre">+([^</span> <span class="pre">]+)</span> <span class="pre">Duration</span> <span class="pre">:</span> <span class="pre">([^</span> <span class="pre">]+</span> <span class="pre">ms)/\3</span> <span class="pre">\2</span> <span class="pre">\1/g&quot;</span> <span class="pre">|sort</span> <span class="pre">-n</span></code></li>
</ul>
</li>
<li>check send emails<ul>
<li><code class="docutils literal"><span class="pre">for</span> <span class="pre">a</span> <span class="pre">in</span> <span class="pre">sent</span> <span class="pre">deferred</span> <span class="pre">bounced;</span> <span class="pre">do</span> <span class="pre">echo</span> <span class="pre">&quot;####</span> <span class="pre">$a&quot;;</span> <span class="pre">journalctl</span> <span class="pre">-u</span> <span class="pre">postfix</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">&quot;status=$a&quot;</span> <span class="pre">|</span> <span class="pre">awk</span> <span class="pre">'{print</span> <span class="pre">$7}'</span> <span class="pre">|</span> <span class="pre">sed</span> <span class="pre">'s/to=&lt;//g'</span> <span class="pre">|</span> <span class="pre">sed</span> <span class="pre">'s/&gt;,//g'</span> <span class="pre">|</span> <span class="pre">sort</span> <span class="pre">-n;</span> <span class="pre">done</span></code></li>
</ul>
</li>
<li>ip adress config<ul>
<li><code class="docutils literal"><span class="pre">ip</span> <span class="pre">-o</span> <span class="pre">addr</span> <span class="pre">show</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">-Ev</span> <span class="pre">&quot;veth[0-9a-f]{7}&quot;;</span> <span class="pre">default_iface=$(awk</span> <span class="pre">'$2</span> <span class="pre">==</span> <span class="pre">00000000</span> <span class="pre">{</span> <span class="pre">print</span> <span class="pre">$1</span> <span class="pre">}'</span> <span class="pre">/proc/net/route);</span> <span class="pre">default_ip=$(ip</span> <span class="pre">addr</span> <span class="pre">show</span> <span class="pre">dev</span> <span class="pre">&quot;$default_iface&quot;</span> <span class="pre">|</span> <span class="pre">awk</span> <span class="pre">'$1</span> <span class="pre">==</span> <span class="pre">&quot;inet&quot;</span> <span class="pre">{</span> <span class="pre">sub(&quot;/.*&quot;,</span> <span class="pre">&quot;&quot;,</span> <span class="pre">$2);</span> <span class="pre">print</span> <span class="pre">$2</span> <span class="pre">}');</span> <span class="pre">echo</span> <span class="pre">&quot;Default</span> <span class="pre">Interface:</span> <span class="pre">$default_iface</span> <span class="pre">,</span> <span class="pre">Default</span> <span class="pre">IP:</span> <span class="pre">$default_ip</span></code></li>
</ul>
</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Maintenance</a><ul>
<li><a class="reference internal" href="#reconfigure-a-running-appliance">Reconfigure a running Appliance</a></li>
<li><a class="reference internal" href="#start-stop-update-appliance">Start, Stop, Update Appliance</a></li>
<li><a class="reference internal" href="#recover-from-failed-state">Recover from failed state</a></li>
<li><a class="reference internal" href="#desaster-recovery-from-backup">Desaster Recovery from backup</a></li>
<li><a class="reference internal" href="#automatic-updates">Automatic Updates</a></li>
<li><a class="reference internal" href="#backup-configuration">Backup Configuration</a></li>
<li><a class="reference internal" href="#logging-configuration">Logging Configuration</a></li>
<li><a class="reference internal" href="#metrics-collection">Metrics Collection</a></li>
<li><a class="reference internal" href="#alerting-setup">Alerting Setup</a></li>
<li><a class="reference internal" href="#email-challenges">Email Challenges</a><ul>
<li><a class="reference internal" href="#mail-send-from-ecs-to-emailserver-doing-greylisting">Mail send from ECS to Emailserver doing greylisting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#maintenance-commands-in-a-running-ecs-container">Maintenance commands in a running ecs container</a></li>
<li><a class="reference internal" href="#maintenance-commands-for-the-appliance-host">Maintenance commands for the appliance host</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="configuration.html"
                        title="previous chapter">Configure Appliance</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="mocca_pdfas.html"
                        title="next chapter">Digital signed pdf documents</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="related bottom">
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="configuration.html" title="Previous document">Configure Appliance</a>
        </li>
        <li>
          <a href="mocca_pdfas.html" title="Next document">Digital signed pdf documents</a>
          &rarr;
        </li>
    </ul>
  </nav>
  <nav id="breadcrumbs">
    <ul>
      <li><a href="index.html">ecs-admin-manual 2019-02-21@14:22 documentation</a></li> 
    </ul>
  </nav>
  </div>
  <footer id="pagefooter">&copy; Copyright 2019 Medizinische Universität Wien, Medizinische Universität Innsbruck, Medizinische Universität Graz, Johannes Kepler Universität Linz, Karl Landsteiner Privatuniversität für Gesundheitswissenschaften, Land Salzburg.

  </footer>

  
  </body>
</html>